<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Private Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #chatBox {
      height: 60vh;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 12px;
    }
    .msg {
      padding: 8px 10px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #f3f4f6;
    }
    .meta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 2px;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h3 class="mb-0">Private Chat</h3>
        <div class="text-muted small" id="info"></div>
      </div>
      <button id="backBtn" class="btn btn-outline-secondary">Back</button>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label">Chat with (username)</label>
        <input id="toUser" class="form-control" placeholder="ex: maziar" />
      </div>
      <div class="col-md-6 d-flex align-items-end">
        <button id="loadBtn" class="btn btn-primary w-100">Load Chat</button>
      </div>
    </div>

    <div id="chatBox" class="mb-3"></div>

    <div class="input-group">
      <input id="message" class="form-control" placeholder="Type your message..." />
      <button id="sendBtn" class="btn btn-success">Send</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    const userRaw = localStorage.getItem("chat_user");
    if (!userRaw) window.location.href = "./login.html";
    const user = JSON.parse(userRaw);

    document.getElementById("info").textContent = `Logged in as: ${user.username}`;

    const socket = io();

    const chatBox = document.getElementById("chatBox");
    const msgInput = document.getElementById("message");
    const toUserInput = document.getElementById("toUser");

    let currentToUser = "";

    function addMessage({ from_user, to_user, message, date_sent }) {
      const wrap = document.createElement("div");
      wrap.className = "msg";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${from_user} → ${to_user} • ${date_sent}`;

      const body = document.createElement("div");
      body.textContent = message;

      wrap.appendChild(meta);
      wrap.appendChild(body);

      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function formatDate(d = new Date()) {
      const pad = (n) => String(n).padStart(2, "0");
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      const yyyy = d.getFullYear();

      let hh = d.getHours();
      const min = pad(d.getMinutes());
      const ampm = hh >= 12 ? "PM" : "AM";
      hh = hh % 12;
      hh = hh === 0 ? 12 : hh;

      return `${mm}-${dd}-${yyyy} ${hh}:${min} ${ampm}`;
    }

    // Load private history
    document.getElementById("loadBtn").addEventListener("click", () => {
      const to_user = toUserInput.value.trim();
      if (!to_user) return alert("Enter a username to chat with.");

      currentToUser = to_user;
      chatBox.innerHTML = "";

      socket.emit("load_private_history", {
        from_user: user.username,
        to_user
      });
    });

    socket.on("private_history", (messages) => {
      chatBox.innerHTML = "";
      messages.forEach(addMessage);
    });

    // Listen for private messages (filter to only show this conversation)
    socket.on("private_message", (payload) => {
      const { from_user, to_user } = payload;

      const isThisConversation =
        (from_user === user.username && to_user === currentToUser) ||
        (from_user === currentToUser && to_user === user.username);

      if (isThisConversation) addMessage(payload);
    });

    // Send private message
    function sendPrivate() {
      const text = msgInput.value.trim();
      if (!text) return;
      if (!currentToUser) return alert("Load a chat first.");

      socket.emit("send_private_message", {
        from_user: user.username,
        to_user: currentToUser,
        message: text,
        date_sent: formatDate(),
      });

      msgInput.value = "";
    }

    document.getElementById("sendBtn").addEventListener("click", sendPrivate);
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendPrivate();
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "./rooms.html";
    });
  </script>
</body>
</html>
